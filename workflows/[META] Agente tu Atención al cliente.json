{
  "active": false,
  "connections": {
    "Recibir mensaje": {
      "main": [
        [
          {
            "node": "Switch Tipo de Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Tipo de Entrada": {
      "main": [
        [
          {
            "node": "Obtener imagen",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Texto - mensaje",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Descarga de Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Centro de Datos": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descarga de Audio": {
      "main": [
        [
          {
            "node": "Obtener Archivo de Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Archivo de Audio": {
      "main": [
        [
          {
            "node": "Transcribir audio a texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribir audio a texto": {
      "main": [
        [
          {
            "node": "Recepción de texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se transcribio el audio?": {
      "main": [
        [
          {
            "node": "Centro de Datos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Audio no entendible",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recepción de texto": {
      "main": [
        [
          {
            "node": "Se transcribio el audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Salio bien el proceso?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Salio bien el proceso?": {
      "main": [
        [
          {
            "node": "Contestar mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto - mensaje": {
      "main": [
        [
          {
            "node": "Centro de Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisis de imagen": {
      "main": [
        [
          {
            "node": "Orden Agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener imagen": {
      "main": [
        [
          {
            "node": "Descargar imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar imagen": {
      "main": [
        [
          {
            "node": "Analisis de imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Orden Agente": {
      "main": [
        [
          {
            "node": "Centro de Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Wikipedia": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Explicar imagen": {
      "main": [
        [
          {
            "node": "Clasificar_IMAGEN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI AgentTubiblia1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Postgres chat_histories1": {
      "ai_memory": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "EXTRAER INFORMACION DE COMPROBANTE": {
      "main": [
        [
          {
            "node": "DATOS_Comprobante",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DATOS_Comprobante": {
      "main": [
        [
          {
            "node": "Obtener datos del usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Eliminar visualizacion_previo_correo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simulación_escritura": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mdelo LLM Principal": {
      "ai_languageModel": [
        [
          {
            "node": "Explicar imagen",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Clasificar_IMAGEN",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "EXTRAER INFORMACION DE COMPROBANTE",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Clasificar_PDF",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "EXTRAER INFORMACION DE COMPROBANTE1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "TEXTO": {
      "main": [
        [
          {
            "node": "Obtener datos del usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificar_IMAGEN": {
      "main": [
        [
          {
            "node": "EXTRAER INFORMACION DE COMPROBANTE",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener datos del usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EXTRAER INFORMACION DE COMPROBANTE1": {
      "main": [
        [
          {
            "node": "DATOS_Comprobante1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DATOS_Comprobante1": {
      "main": [
        [
          {
            "node": "Obtener datos del usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener datos del usuario1": {
      "main": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar_cliente": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_cliente": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Registrar_Cliente": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pais": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Consultar_FAQ",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Consultar_FAQ": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Consultar_FAQ",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Generar_factura": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "WooCommerce": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Eliminar visualizacion_previo_correo": {
      "main": [
        [
          {
            "node": "Separador_Humanizador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Asesor": {
      "ai_tool": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Clasificar_PDF": {
      "main": [
        [
          {
            "node": "EXTRAER INFORMACION DE COMPROBANTE1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener datos del usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Separador_Humanizador": {
      "main": [
        [
          {
            "node": "Simulación_escritura",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar_mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "Gmail1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail1": {
      "main": [
        [
          {
            "node": "Mensaje Administracion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Administracion": {
      "main": [
        [
          {
            "node": "Enviar_mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Tipo de Entrada1": {
      "main": [
        [
          {
            "node": "Descarga de Audio1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener imagen1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "TEXTO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media": {
      "main": [
        [
          {
            "node": "Descargar pdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar pdf": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Clasificar_PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recibir mensaje1": {
      "main": [
        [
          {
            "node": "Switch Tipo de Entrada1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Descarga de Audio1": {
      "main": [
        [
          {
            "node": "Obtener Archivo de Audio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Archivo de Audio1": {
      "main": [
        [
          {
            "node": "Transcribir audio a texto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribir audio a texto1": {
      "main": [
        [
          {
            "node": "Recepción de texto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se transcribio el audio?1": {
      "main": [
        [
          {
            "node": "Obtener datos del usuario1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Audio no entendible1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recepción de texto1": {
      "main": [
        [
          {
            "node": "Se transcribio el audio?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar imagen1": {
      "main": [
        [
          {
            "node": "Explicar imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener imagen1": {
      "main": [
        [
          {
            "node": "Descargar imagen1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI AgentTubiblia1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-21T21:35:36.733Z",
  "id": "kg8MXl7tN8mCfaEJ",
  "isArchived": true,
  "meta": null,
  "name": "[META] Agente tu Atención al cliente",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -496,
        608
      ],
      "id": "bf9c41d5-2d0b-4344-8c64-5ad8e975b142",
      "name": "Recibir mensaje",
      "webhookId": "40becde5-9509-41e7-9bd7-8e620cd80818"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messages[0].image }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "90fcac00-01b7-4992-b6b8-6cb00cda7f56"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Foto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6ef5fd99-c137-4ecb-8716-a8212a98c65e",
                    "leftValue": "={{ $json.messages[0].text.body.toString() }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d13eb9a7-fae6-4906-b7ff-7a7b0c4cc08d",
                    "leftValue": "={{ $json.messages[0].audio }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voz"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5b3b5546-0bb5-4594-87fc-fa4b748cb760",
                    "leftValue": "={{ $json.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -288,
        576
      ],
      "id": "64bc426b-e84a-4eae-8ccf-1222a5f03909",
      "name": "Switch Tipo de Entrada"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4980e8c2-6435-42bf-b8c0-21afaa744e14",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "1314e2a9-d7ab-4c94-aab0-8fd2f1b4f178",
              "name": "id",
              "value": "={{ $json.id ||  $('Recibir mensaje').item.json.contacts[0].wa_id  }}",
              "type": "string"
            },
            {
              "id": "dcf58be8-4ba3-4ce9-975c-0b90e9d26dfb",
              "name": "timestamp",
              "value": "={{  $json.timestamp || $('Recibir mensaje').item.json.messages[0].timestamp  }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1024,
        592
      ],
      "id": "429d3385-15c2-40b4-b5e4-25532dcc503d",
      "name": "Centro de Datos"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "831953883325563",
        "recipientPhoneNumber": "={{ $('Recibir mensaje').item.json.contacts[0].wa_id }}",
        "textBody": "Lo siento puedes repetir el audio no es entendible.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        0,
        1440
      ],
      "id": "94bede27-d6cd-49c2-b01d-963bfcfa55b3",
      "name": "Audio no entendible",
      "webhookId": "54ff05b3-0a58-4905-afcc-c5f9b7a9378b"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -48,
        1008
      ],
      "id": "0a34e6d7-d817-46a4-8389-18aec6f2709c",
      "name": "Descarga de Audio",
      "webhookId": "27dc4348-d6eb-45e6-8bf7-478ee0ee4aae"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        608,
        1008
      ],
      "id": "08fbd2e2-3dd2-4b49-ae15-7f9303ab8010",
      "name": "Obtener Archivo de Audio"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -16,
        1216
      ],
      "id": "b81d79d5-1cf8-4755-83ef-20067e9fcdd6",
      "name": "Transcribir audio a texto"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6fb0cb6b-8267-4073-a4c5-03f3b8724281",
              "leftValue": "={{ $json.text }}",
              "rightValue": "Subtítulos realizados por la comunidad de Amara.org",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        592,
        1216
      ],
      "id": "6dc6e90c-0217-4648-b4e2-a75fbe50d3f2",
      "name": "Se transcribio el audio?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c0da9ea0-b86b-49e5-abf9-53c8e3d5b152",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        272,
        1216
      ],
      "id": "123d635b-5d26-487b-a54a-30b2c4494617",
      "name": "Recepción de texto"
    },
    {
      "parameters": {
        "content": "## MANEJO DE  VOZ\n* Nodo de ia se encarga de traducir todo el audio y pasarlo como texto\n* Manejo de errores en caso de no entender ningun audio.",
        "height": 704,
        "width": 848
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -80,
        880
      ],
      "typeVersion": 1,
      "id": "ef329896-cdf2-4efa-b900-4ed1d717ef19",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}",
        "options": {
          "systemMessage": "=# Descripción\n\n- Eres un asistente de AI que apoya las peticiones del usuario de forma eficiente.\n- Siempre revisa la memoria para darle seguimiento a las conversaciones con el usuario.\n\n## TOOLS \n### WIKIPEDIA\n- Usa esta herramienta cuando el usuario pida información actual.\n\n## Dia y hora: {{$now}}\n\n## ESTILO\nEmpático, claro, formal pero no rígido."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1248,
        592
      ],
      "id": "7e837f91-ccbf-468f-a6e5-4d92b60df380",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Recibir mensaje').item.json.contacts[0].wa_id + \"multientrance\" }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1344,
        784
      ],
      "id": "2033ddc5-f01f-4023-b6a9-232477c8555f",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "831953883325563",
        "recipientPhoneNumber": "={{ $('Centro de Datos').item.json.id }}",
        "textBody": "= {{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1824,
        496
      ],
      "id": "e1cd26c2-6658-4a76-a3f7-bc68b8be72a3",
      "name": "Contestar mensajes",
      "webhookId": "16e96e69-73ae-4667-852a-3ca82d7a4831"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9a93fdd1-306b-43a0-a0e0-e102c2869af0",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1600,
        592
      ],
      "id": "a1b138d5-4a29-4532-8015-16dc9d00b572",
      "name": "Salio bien el proceso?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a9d93b1c-882d-4f13-b851-222d66d49620",
              "name": "text",
              "value": "={{ $json.messages[0].text.body  }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        336,
        592
      ],
      "id": "29f61ad0-20ca-4e71-be07-bced9e248b89",
      "name": "Texto - mensaje"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "=Instrucciónes: {{  $('Switch Tipo de Entrada').item.json.messages[0].image.caption  || \"Describe la imagen\" }}\n",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -16,
        384
      ],
      "id": "c2b7726f-b5ff-4a6d-8f41-6edd56c8b093",
      "name": "Analisis de imagen"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].image.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        0,
        128
      ],
      "id": "5b31c5a7-c94e-413c-96f9-2f2b3d4e0dac",
      "name": "Obtener imagen",
      "webhookId": "46085bb4-9128-4538-9685-3a0826c250ed"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        320,
        128
      ],
      "id": "caf70184-141d-4c17-8c06-67a17b5fdcae",
      "name": "Descargar imagen"
    },
    {
      "parameters": {
        "content": "## MANEJO DE  IMAGEN\n* Nodo de ia se encarga de recibir todas las imágenes y crear una descripcion de las mismas\n* La orden del proceso puede ser cambiado con el texto del embebido o adjunto",
        "height": 592,
        "width": 848
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -96,
        0
      ],
      "typeVersion": 1,
      "id": "044f53fc-498e-439d-860d-f86911a22895",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "771753819357403",
        "recipientPhoneNumber": "={{ $('Centro de Datos').item.json.id }}",
        "textBody": "Lo sentimos tuvimos un error !!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1808,
        720
      ],
      "id": "bf4e808a-0a99-48c8-94b2-9476224dfc41",
      "name": "Error",
      "webhookId": "16e96e69-73ae-4667-852a-3ca82d7a4831"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a640292b-ce04-493e-948e-d528ead807f8",
              "name": "text",
              "value": "=- Estos datos provienen de un nodo de analisis de imagenes contesta conforme a la peticion del usuario.\n\n## Peticion del usuario:\n{{ $('Recibir mensaje').item.json.messages[0].image.caption || \"responde con la descripcion\"}}\n\n## Descripción de la imagen: \n{{\n$json.content \n}} \n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        608,
        384
      ],
      "id": "f88ffc23-ef84-4092-8e00-c227709c56cb",
      "name": "Orden Agente"
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1184,
        768
      ],
      "id": "d5d763ad-b88a-419d-84d9-0d079d6deec9",
      "name": "OpenRouter Chat Model"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolWikipedia",
      "typeVersion": 1,
      "position": [
        1488,
        784
      ],
      "id": "d7019bf9-0356-4db1-95b3-c075e4191bb7",
      "name": "Wikipedia"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Aquí tienes una imagen enviada por el usuario. Describe la imagen y transcribe cualquier texto visible en la imagen. Incluye tantos detalles como sea posible.",
        "messages": {
          "messageValues": [
            {
              "type": "HumanMessagePromptTemplate",
              "messageType": "imageBinary"
            }
          ]
        }
      },
      "id": "4ca1770e-209a-4c72-ab3b-f150aed34d83",
      "name": "Explicar imagen",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -3296,
        2864
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "content": "## Receptor de Imagenes\nDescarga y explica una imagen enviada del usuario\n",
        "height": 340,
        "width": 1684,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3792,
        2736
      ],
      "typeVersion": 1,
      "id": "0ca473f6-dea3-4ef0-9ab4-9fe467f22530",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## Enrutador\nValida el tipo de mensaje del usuario\n",
        "height": 440,
        "width": 300,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4448,
        3168
      ],
      "typeVersion": 1,
      "id": "9f4acf93-026f-4abb-b665-93bfb506d748",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Receptor de mensaje de texto\nResume el mensaje de texto del usuario\n",
        "height": 240,
        "width": 560,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3360,
        3664
      ],
      "typeVersion": 1,
      "id": "1849dc0a-3517-45f6-bb58-5ee407db5d73",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## SALIDA a WHATSAPP.\nHumanización de respuesta a usuario.\n\n",
        "height": 480,
        "width": 1680,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -48,
        3216
      ],
      "typeVersion": 1,
      "id": "c2eeb603-4dc2-41ed-bd4b-635d2b85de4c",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "## Agente de IA \n\n",
        "height": 680,
        "width": 1304,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1536,
        2544
      ],
      "typeVersion": 1,
      "id": "1bdd40f9-19e1-4042-bec9-b04da6fe3490",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.Message_text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=# 👤 ROL\n\nEres un Agente de IA que gestiona clientes en WhatsApp para \"\". Ayudas a encontrar y comprar biblias y libros cristianos.\n\n# 🚀 INSTRUCCIONES INICIALES\n\n**SALUDO INICIAL (PRIMER MENSAJE):**\n```\n¡Hola! Bendiciones🎉 \n¡Bienvenido a tu https://tubiblia.com.co/ 📚✨\n\"Estamos felices de que estés aquí. Vas a encontrar el mundo bíblico a tu alcance. Si necesitas recomendaciones u orientación, ¡no dudes en preguntar! Estamos para ayudarte a encontrar el libro o la biblia perfecta. 🚀📖 ¡Empecemos!\n\"\n```\n\n### 2️⃣ Primera acción\nDespués del saludo inicial, **llama a la herramienta `Pais` con: {{ $json.telefono }}\n\n### 3️⃣ Flujo según resultado de `Pais`\n\n#### Caso A: `Pais = extranjero`\n1. Enviar:  \n   `\"Somos importadores directos de las biblias y estamos ubicados en Colombia. Para qué ciudad sería la entrega?\"`  \n2. Esperar respuesta del cliente → ciudad.\n3. Confirmar:  \n   `\"Gracias. Para confirmar, ¿la ciudad de [Ciudad] para la entrega se encuentra en Colombia?\"`\n4. Evaluar:\n   - **Si responde SÍ** → Pedir nombre y continuar con flujo normal (como si fuera de Colombia).  \n   - **Si responde NO** → Agradecer e invitar a seguir en Instagram:  \n     `\"Entendemos. Actualmente solo realizamos envíos dentro de Colombia. ¡Te agradecemos mucho tu interés! Para más novedades y contenido interesante, síguenos en Instagram: https://www.instagram.com/tubiblia.com.co/?hl=es\"`\n\n#### Caso B: `Pais = colombia`\n- No mencionar país.  \n- Preguntar nombre y cómo puedes ayudar.  \n  Ejemplo: `\"Para poder dirigirme a ti mejor, ¿me podrías decir tu nombre, por favor? Y cuéntame, ¿en qué puedo ayudarte hoy?\"`\n\n---\n\n## 📋 Tareas\n\n### 📌 1. Consulta de productos\n**Tool:** `WooCommerce`\n\n**Acciones:**\n- Consultar producto en WooCommerce.  \n- Si disponible → enviar **nombre + breve descripción + URL**.  \n- Si agotado → ofrecer alternativos o indicar que verificarás disponibilidad.  \n- Recordar siempre: puede comprar en WhatsApp o web con el link.  \n- Si no hay claridad, pedir más información (edad, gustos, tema, etc.).  \n- Buscar también sinónimos (ej: oración → orar, rezar).  \n- **Regla extranjero:** si no confirmó ciudad en Colombia, añadir:  \n  `\"Solo como recordatorio, nuestros envíos se realizan únicamente dentro de Colombia.\"`  \n- Si pregunta sobre cristianismo/iglesia católica → siempre ofrecer libros relacionados usando `WooCommerce`.\n\n---\n\n### 📌 2. Preguntas frecuentes\n**Tool:** `Consultar_FAQ`\n\n**Cuándo usar:** Preguntas generales sobre ubicación, mayoristas, contraentrega, tiempos de entrega, medios de pago, donaciones, garantías, digital/PDF, seguridad, envíos internacionales, etc.\n\n**Acciones:**\n- Pasar la consulta exacta del cliente a `Consultar_FAQ`.  \n- Responder de forma natural (no mencionar FAQs ni base de datos).  \n- Si tema requiere asesor (ej: mayoristas, donaciones complejas, dudas sin respuesta) →  \n  1. Enviar frase de espera: `\"Entendido. Deme un momento por favor ya estoy con usted.\"`  \n  2. Llamar a `Asesor` con:  \n     - `telefono`: `{{ $json.telefono }}`  \n     - `nombre`: si se conoce  \n     - `motivo`: consulta original del cliente  \n  3. **No enviar más mensajes al cliente sobre este tema.**\n\n---\n\n### 📌 3. Flujo de compra\nDos opciones: **Web** o **WhatsApp**.\n\n#### ▶️ Opción 1: Web\n- Enviar link: https://tubiblia.com.co/ o URL del producto (desde WooCommerce).  \n- Luego → llamar a `Asesor` para seguimiento.\n\n#### ▶️ Opción 2: WhatsApp\n**Paso 1: Método de pago**  \n- Ofrecer: Bancolombia, Davivienda o Nequi.  \n- Según respuesta → enviar datos bancarios.  \n- Si cliente elige web → enviar link + llamar a `Asesor` y cerrar flujo.\n\n**Paso 2: Verificación/Registro**  \n- Tool: `Buscar_cliente` con `{{ $json.telefono }}`.  \n- Si existe → mostrar datos y confirmar.  \n  - Si correctos y TyC aceptados → seguir.  \n  - Si correctos y TyC no aceptados → mostrar link TyC + preguntar.  \n    - Si acepta → `Actualizar_cliente` con `TyC = Sí`.  \n    - Si no acepta → llamar a `Asesor`.  \n  - Si datos incorrectos → pedir corrección y actualizar con `Actualizar_cliente`.  \n- Si no existe → iniciar registro:  \n  - Mostrar TyC + Política.  \n  - Si acepta → pedir datos (ID, nombre, dirección, ciudad, correo).  \n  - Confirmar todos los datos.  \n  - Registrar con `Registrar_cliente`.\n\n---\n\n## 🛠️ Tools utilizadas\n- `Pais` → Identificar si cliente está en Colombia o extranjero.  \n- `WooCommerce` → Consultar disponibilidad de productos.  \n- `Consultar_FAQ` → Responder preguntas frecuentes.  \n- `Asesor` → Escalar consultas que requieren intervención humana.  \n- `Buscar_cliente` → Verificar datos de cliente.  \n- `Registrar_cliente` → Nuevo registro.  \n- `Actualizar_cliente` → Actualizar datos existentes.\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        -960,
        2704
      ],
      "id": "56de60a8-5562-40df-8405-2451fe155349",
      "name": "AI AgentTubiblia1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.telefono +\"tubibliaTEST\"}}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -1296,
        2944
      ],
      "id": "7c720468-b819-4753-9116-88225c1283cc",
      "name": "Postgres chat_histories1"
    },
    {
      "parameters": {
        "text": "={{ $json.text }}",
        "attributes": {
          "attributes": [
            {
              "name": "importe",
              "description": "El monto o valor numérico exacto de la transferencia mencionado en el texto.",
              "required": true
            },
            {
              "name": "ordenante",
              "description": "Nombre del ordenante que ha hecho la transferencia",
              "required": true
            },
            {
              "name": "fecha_pago",
              "description": "Fecha en la que ha hecho el pago"
            },
            {
              "name": "concepto",
              "description": "Concepto o descripción que ha usado al hacer la transferencia"
            },
            {
              "name": "referencia",
              "description": "Número de referencia o numero de transferencia o de registro de la transferencia"
            },
            {
              "name": "Nombre_beneficiario",
              "description": "Nombre del beneficiario de la transferencia"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        -2592,
        2864
      ],
      "id": "9db4aad0-5f59-465b-9286-252d03095e0f",
      "name": "EXTRAER INFORMACION DE COMPROBANTE"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "71a6ecc5-dcc5-4417-be55-6bc51288a5e5",
              "name": "text",
              "value": "=[MENSAJE_SISTEMA: Comprobante de pago detectado. \nDatos extraídos:\n- Importe:{{ $json.output.importe }}\n- Concepto: {{ $json.output.concepto }}\n- Ordenante:{{ $json.output.ordenante }}\n- Fecha: {{ $json.output.fecha_pago }}\n- Referencia: {{ $json.output.referencia }}\nPor favor, acusa recibo al usuario e informa sobre la verificación manual.]",
              "type": "string"
            },
            {
              "id": "fa35e9f9-6e8d-4128-b996-74c3ebda9037",
              "name": "numero_telefono",
              "value": "57311234672",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2240,
        2864
      ],
      "id": "fd825b05-7445-4162-b7c9-520619314be2",
      "name": "DATOS_Comprobante"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        -16,
        3136
      ],
      "id": "86326070-6365-43ad-8c4d-c0276d66d2a9",
      "name": "Merge"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        96,
        3744
      ],
      "id": "608ce793-1199-4ce4-b0d5-8e9237ebedd0",
      "name": "Merge1"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        720,
        3472
      ],
      "id": "495f1337-d408-44e9-a379-8e94b64c3959",
      "name": "Simulación_escritura",
      "webhookId": "656cbd71-2c95-447d-8e46-d9176929ee24"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "frequencyPenalty": 0.3,
          "maxTokens": 2000,
          "responseFormat": "text",
          "presencePenalty": 0,
          "temperature": 0.5,
          "maxRetries": 2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2736,
        3216
      ],
      "id": "9f9f1a46-1c20-416a-8f66-30566abb045b",
      "name": "Mdelo LLM Principal"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d3f13840-d3a0-43c2-90d5-fa9a6ebe04d8",
              "name": "text",
              "value": "={{ $json.messages[0].text.body  }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3424,
        3152
      ],
      "id": "00191747-3a94-4188-9cba-e94cfccbf10c",
      "name": "TEXTO"
    },
    {
      "parameters": {
        "inputText": "={{ $json.text }}",
        "categories": {
          "categories": [
            {
              "category": "COMPROBANTE_DETECTADO",
              "description": "\"El texto describe una imagen o contiene texto que parece ser un comprobante de pago, recibo de transferencia bancaria, mencionando bancos, montos, fechas, o el IBAN/nombre de la tienda.\""
            },
            {
              "category": "IMAGEN_GENERAL",
              "description": "\"El texto describe una imagen que no parece ser un comprobante de pago, o es texto general no relacionado con una transacción.\""
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textClassifier",
      "typeVersion": 1,
      "position": [
        -2944,
        2864
      ],
      "id": "fd5e3a01-c4ca-415b-a102-51c4e587839a",
      "name": "Clasificar_IMAGEN"
    },
    {
      "parameters": {
        "text": "={{ $json.text }}",
        "attributes": {
          "attributes": [
            {
              "name": "importe",
              "description": "El monto o valor numérico exacto de la transferencia mencionado en el texto.",
              "required": true
            },
            {
              "name": "ordenante",
              "description": "Nombre del ordenante que ha hecho la transferencia",
              "required": true
            },
            {
              "name": "fecha_pago",
              "description": "Fecha en la que ha hecho el pago"
            },
            {
              "name": "concepto",
              "description": "Concepto o descripción que ha usado al hacer la transferencia"
            },
            {
              "name": "referencia",
              "description": "Número de referencia o de registro de la transferencia"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        -2592,
        3472
      ],
      "id": "3e9468b8-cdde-42d3-bd1c-c13f088afb35",
      "name": "EXTRAER INFORMACION DE COMPROBANTE1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "71a6ecc5-dcc5-4417-be55-6bc51288a5e5",
              "name": "text",
              "value": "=[MENSAJE_SISTEMA: Comprobante de pago detectado. \nDatos extraídos:\n- Importe:{{ $json.output.importe }}\n- Concepto: {{ $json.output.concepto }}\n- Ordenante:{{ $json.output.ordenante }}\n- Fecha: {{ $json.output.fecha_pago }}\n- Referencia: {{ $json.output.referencia }}\nPor favor, acusa recibo al usuario e informa sobre la verificación manual.]",
              "type": "string"
            },
            {
              "id": "fa35e9f9-6e8d-4128-b996-74c3ebda9037",
              "name": "numero_telefono",
              "value": "57311234672",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2240,
        3472
      ],
      "id": "6dcc6e1b-58ce-4685-95ea-b2068caeab2f",
      "name": "DATOS_Comprobante1"
    },
    {
      "parameters": {
        "content": "# 3 -> RECOPILACIÓN \n",
        "height": 1484,
        "width": 360,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2032,
        2432
      ],
      "id": "fd0f40b3-f2d7-4ce0-a423-c2b4017eef60",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "# 2 -> CLASIFICACION Y PREPARACIÓN DATOS\n",
        "height": 2236,
        "width": 1860,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3952,
        1744
      ],
      "id": "e52eec33-1bb9-43e4-a46d-5fb27c987cba",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "# 4-> PROCESAMIENTO y GESTIÓN\n",
        "height": 1468,
        "width": 1508,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1664,
        2512
      ],
      "id": "958d33f5-2fe6-4d9d-bb29-f44acd15b4b5",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "# ENVÍO INFORMACIÓN\n",
        "height": 1460,
        "width": 1776,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -48,
        2416
      ],
      "id": "d2e19699-b004-4996-831a-de130ce8317b",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "# 1 -> RECEPCIÓN y FILTRADO\n",
        "height": 1420,
        "width": 760,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4752,
        2528
      ],
      "id": "c03ca497-1d69-49c6-a794-46b67d81bec3",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "310c0cce-bd8e-43b1-b40e-850a9d8a1daa",
              "name": "Destinatario",
              "value": "={{ $('Recibir mensaje1').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "080faabe-abf9-45ee-9711-1f475c3742c3",
              "name": "Instancia",
              "value": "=\"Instancia?\"",
              "type": "string"
            },
            {
              "id": "04f7b0d5-9a52-4594-b71c-04a1b4c95e47",
              "name": "ID del mensaje",
              "value": "={{ $('Recibir mensaje1').item.json.messages[0].id }}",
              "type": "string"
            },
            {
              "id": "e90cf818-d301-4ee8-9045-28475b788d43",
              "name": "Nombre de la persona",
              "value": "={{ $('Recibir mensaje1').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "57a94aeb-d961-44f3-bbfa-651468943d10",
              "name": "data_time",
              "value": "={{ $('Recibir mensaje1').item.json.messages[0].timestamp }}",
              "type": "string"
            },
            {
              "id": "6c54c588-ec1a-425a-bf25-3f4b4705898a",
              "name": "Message_text",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "045c368e-1b0b-4610-9737-566fec5b0b9b",
              "name": "telefono",
              "value": "={{ $('Recibir mensaje1').item.json.contacts[0].wa_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1872,
        3136
      ],
      "id": "c4525991-83f4-4fec-a8ea-3485d5fd2741",
      "name": "Obtener datos del usuario1"
    },
    {
      "parameters": {
        "name": "Actualizar_cliente",
        "description": "=Utiliza esta herramienta para actualizar y corregir los datos del cliente.\nPasa los campos que se quieren corregir con los valores nuevos a corregir. Por ejemplo\n\"direccion\":\"nuevadirección\" o \"Ciudad\":\"Nueva ciudad\"\n\nPasa siempre el campo \"identificacion\" para poder hacer la búsqueda.\n",
        "workflowId": {
          "__rl": true,
          "value": "nZSepbQwDbURKKJw",
          "mode": "list",
          "cachedResultName": "Actualizar_cliente"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -1136,
        3040
      ],
      "id": "930a1e51-442b-4bf7-97c1-a2210e4fc1aa",
      "name": "Actualizar_cliente"
    },
    {
      "parameters": {
        "name": "Buscar_cliente",
        "description": "Utiliza esta herramienta para buscar un cliente en la base de datos.",
        "workflowId": {
          "__rl": true,
          "value": "eo3SnPmxQiW7pkOO",
          "mode": "list",
          "cachedResultName": "BuscarCliente Biblias"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -1008,
        3040
      ],
      "id": "5c1bf37e-2e97-4e36-a79a-2cc8e929d08c",
      "name": "Buscar_cliente"
    },
    {
      "parameters": {
        "name": "Registrar_Cliente",
        "description": "=Utiliza esta herramienta para registrar un cliente nuevo.\n\nPasa los datos recopilados: en un objeto JSON.\n                ",
        "workflowId": {
          "__rl": true,
          "value": "xLMyQsFyjk8ZqLIK",
          "mode": "list",
          "cachedResultName": "Registrar_Cliente Biblias"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -896,
        3040
      ],
      "id": "865e541e-e798-43bb-ac8d-b43f1ad3babb",
      "name": "Registrar_Cliente"
    },
    {
      "parameters": {
        "name": "Pais",
        "description": "Esta herramienta sirve para averiguar desde que país conecta el cliente. Pasa la variable {{ $json.numero_telefono }}",
        "workflowId": {
          "__rl": true,
          "value": "up4vRjLOvJX7yqTy",
          "mode": "list",
          "cachedResultUrl": "/workflow/up4vRjLOvJX7yqTy",
          "cachedResultName": "pais"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono_pais": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefono_pais', ``, 'string') }}"
          },
          "matchingColumns": [
            "telefono_pais"
          ],
          "schema": [
            {
              "id": "telefono_pais",
              "displayName": "telefono_pais",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -816,
        2928
      ],
      "id": "e15d35f5-131b-4e9e-914c-a4ac4f4d84e7",
      "name": "Pais"
    },
    {
      "parameters": {
        "pineconeIndex": {
          "__rl": true,
          "value": "n8nrag",
          "mode": "list",
          "cachedResultName": "n8nrag"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1,
      "position": [
        -864,
        3408
      ],
      "id": "2780974d-8fe5-480b-beb4-48f4a0040ce2",
      "name": "Pinecone Vector Store"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1072,
        3440
      ],
      "id": "46e19cdc-e815-477a-a521-34e92927387c",
      "name": "Embeddings OpenAI1"
    },
    {
      "parameters": {
        "content": "Preguntas frecuentes",
        "height": 220,
        "width": 380,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -576,
        3440
      ],
      "id": "e955c3fe-62ea-49cf-af7d-f1d1b8bd1064",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "name": "Consultar_FAQ",
        "description": "Busca y recupera respuestas a preguntas frecuentes (FAQs) sobre la tienda Tubiblia.com.co. Útil para consultas sobre ubicación, ventas al por mayor, tiempos de entrega, envíos, medios de pago, garantía, originalidad de productos, y direcciones de tiendas."
      },
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        -496,
        3520
      ],
      "id": "4074ae61-5e43-4bde-a5d0-d106865a6ded",
      "name": "Consultar_FAQ"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -784,
        3616
      ],
      "id": "e6fe1846-96b8-40f0-a002-d3e06836f16f",
      "name": "OpenAI Chat Model1"
    },
    {
      "parameters": {
        "name": "Generar_factura",
        "description": "Llama a esta herramienta cuando se haya detectado un envío de comprobante con los datos que se tenga.",
        "workflowId": {
          "__rl": true,
          "value": "KbmDH53YlEB257iw",
          "mode": "list",
          "cachedResultName": "Facturar"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Importe": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Importe', ``, 'string') }}",
            "Concepto": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Concepto', ``, 'string') }}",
            "Ordenante": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Ordenante', ``, 'string') }}",
            "Fecha": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha', ``, 'string') }}",
            "Referencia": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Referencia', ``, 'string') }}",
            "telefono": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefono', ``, 'string') }}",
            "destinatario": "={{ $('Obtener datos del usuario1').item.json.Destinatario }}",
            "nombre instancia": "={{ $('Obtener datos del usuario1').item.json.Instancia }}",
            "id evolution bot": "={{ $('Obtener datos del usuario1').item.json['ID del mensaje'] }}",
            "data": "={{ $('Obtener imagen1').item.json.url }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Importe",
              "displayName": "Importe",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Concepto",
              "displayName": "Concepto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Ordenante",
              "displayName": "Ordenante",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fecha",
              "displayName": "Fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Referencia",
              "displayName": "Referencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "nombre instancia",
              "displayName": "nombre instancia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "destinatario",
              "displayName": "destinatario",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "id evolution bot",
              "displayName": "id evolution bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -688,
        2928
      ],
      "id": "ed6c37ac-c7cc-4293-8395-247d603a8968",
      "name": "Generar_factura"
    },
    {
      "parameters": {
        "name": "WooCommerce",
        "description": "Llama a esta herramienta para buscar libros y productos.",
        "workflowId": {
          "__rl": true,
          "value": "hdgJe8hzt8tbTXRK",
          "mode": "list",
          "cachedResultName": "WooCommerce"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('query', ``, 'string') }}"
          },
          "matchingColumns": [
            "query"
          ],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -560,
        2928
      ],
      "id": "bf60a00b-dd5d-4bfe-a6dd-5c51fde64d9b",
      "name": "WooCommerce"
    },
    {
      "parameters": {
        "jsCode": "// Get the single input item object directly\n// In this mode, $input.item usually refers to the single item data structure\nconst item = $input.item;\n\n// Check if the 'json' property and the 'output' property exist within the item\n// AND ensure 'output' is actually a string before trying to modify it\nif (item.json && typeof item.json.output === 'string') {\n\n  // Read the text directly from item.json.output\n  let messageText = item.json.output;\n\n  // --- Regex Logic (remains the same) ---\n  // Expresión regular para encontrar dominios después de '@'\n  const emailDomainRegex = /@([a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/g;\n\n  // Reemplaza solo los dominios de correo electrónico\n  messageText = messageText.replace(emailDomainRegex, (match, domain) => {\n    // Inserta un espacio de ancho cero entre cada caracter del dominio\n    const modifiedDomain = domain.split('').join('\\u200B');\n    return '@' + modifiedDomain;\n  });\n  // --- End of Regex Logic ---\n\n  // Write the modified text back directly to item.json.output\n  item.json.output = messageText;\n\n} else {\n  // Optional: Log a warning if the expected path wasn't found or wasn't a string\n  if (!item.json) {\n      console.log(\"Warning: Input item did not contain 'json' property.\");\n  } else if (typeof item.json.output !== 'string') {\n      console.log(\"Warning: Input item's 'json.output' property was not a string. Value:\", item.json.output);\n  }\n}\n\n// Return the potentially modified item object itself\n// This is what the next node will receive\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        3472
      ],
      "id": "582e6482-c560-4430-ad35-8c93f13f1f32",
      "name": "Eliminar visualizacion_previo_correo"
    },
    {
      "parameters": {
        "name": "Asesor",
        "description": "Llama a esta herramienta cuando se requiera de un asesor.",
        "workflowId": {
          "__rl": true,
          "value": "fnd1yTm3iY0KvL89",
          "mode": "list",
          "cachedResultName": "Asesor"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $('Obtener datos del usuario1').item.json.telefono }}",
            "nombre instancia": "={{ $('Obtener datos del usuario1').item.json.Instancia }}",
            "id evolution bot": "={{ $('Obtener datos del usuario1').item.json['ID del mensaje'] }}",
            "Nombre": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Nombre', ``, 'string') }}",
            "motivo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('motivo', ``, 'string') }}",
            "Idtelefono": "={{ $('Obtener datos del usuario1').item.json.Destinatario }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nombre instancia",
              "displayName": "nombre instancia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "id evolution bot",
              "displayName": "id evolution bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "motivo",
              "displayName": "motivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "Idtelefono",
              "displayName": "Idtelefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -432,
        2928
      ],
      "id": "c9d124af-64c5-43f3-b511-4ab3871ad078",
      "name": "Asesor"
    },
    {
      "parameters": {
        "inputText": "={{ $json.text }}",
        "categories": {
          "categories": [
            {
              "category": "COMPROBANTE_DETECTADO",
              "description": "=\"El texto  contiene texto que parece ser un comprobante de pago, recibo de transferencia bancaria, mencionando bancos, montos, fechas, o el IBAN/nombre de la tienda.\""
            },
            {
              "category": "IMAGEN_GENERAL",
              "description": "=\"El texto  no parece ser un comprobante de pago, o es texto general no relacionado con una transacción.\""
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textClassifier",
      "typeVersion": 1,
      "position": [
        -2928,
        3456
      ],
      "id": "a19a6d41-fc20-4d7d-ba89-3f2b915dfdb8",
      "name": "Clasificar_PDF"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener el item combinado del nodo Merge\nconst mergedItem = $input.item.json;\n\n// 2. Extraer la información específica directamente del item combinado\nconst fullMessage = mergedItem.output;\nconst destinatario = mergedItem.Destinatario;\nconst instancia = mergedItem.Instancia;\nconst originalMessageId = $input.first().json.messages[0].id\n\n// 3. Dividir el mensaje usando la nueva expresión regular\n//    Divide por doble salto de línea O por un salto de línea seguido de \"Número. \"\nconst regex = /\\n\\n|\\n(?=\\d+\\.\\s)/;\nconst messageParts = fullMessage.split(regex);\n\n// 4. Filtrar partes vacías (igual que antes)\nconst nonEmptyParts = messageParts.filter(part => part.trim() !== '');\n\n// 5. Crear un nuevo item para cada parte del mensaje (igual que antes)\nconst outputItems = nonEmptyParts.map(part => {\n  return {\n    json: {\n      Destinatario: destinatario,\n      Instancia: instancia,\n      originalMessageId: originalMessageId,\n      messagePart: part.trim() // trim() sigue siendo útil aquí\n    }\n  };\n});\n\n// 6. Devolver el array de nuevos items (igual que antes)\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        3472
      ],
      "id": "508826a2-b870-4d4c-9d5b-bee320b894da",
      "name": "Separador_Humanizador"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cd7722b3-9173-4fc8-9431-311882ae3c43",
              "leftValue": "={{ $('Separador_Humanizador').item.json.messagePart }}",
              "rightValue": "no parece estar disponible ",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "2db3e1eb-4222-49b2-b764-4668244402c5",
              "leftValue": "={{ $('Separador_Humanizador').item.json.messagePart }}",
              "rightValue": "parece no estar disponible",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "b0f70dc3-1985-43ee-8814-676744bb4b86",
              "leftValue": "={{ $('Separador_Humanizador').item.json.messagePart }}",
              "rightValue": "no tenemos",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "10f3ac24-f42a-4bce-a11d-402df39703af",
              "leftValue": "={{ $('Separador_Humanizador').item.json.messagePart }}",
              "rightValue": "no encontré",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        896,
        3472
      ],
      "id": "6c948993-6296-4f04-a08a-22f528d99aef",
      "name": "If1"
    },
    {
      "parameters": {
        "sendTo": "sistemas@tubiblia.com.co",
        "subject": "Búsqueda de libro no encontrada",
        "emailType": "text",
        "message": "=Hola equipo de Tubiblia.com\n\nCon hora y fecha siguientes:\n{{ $now.toFormat('dd/MM/yyyy') }}  {{ $now.toFormat('HH:mm:ss') }} \n\nSe ha recibido una busqueda de un libro que no se ha encontrado en la base de datos.\nEl numero del cliente es:{{ $('Merge1').item.json.Destinatario }}\nEl mensaje enviado a cliente con el libro:\n**{{ $('Separador_Humanizador').item.json.messagePart }} \"\n\nPor favor contacten con el cliente en cuanto sea posible\n\nMuchas gracias.\nAgente IA Tubiblia.",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1296,
        3264
      ],
      "id": "6a2f0b4a-ee6a-49a7-be03-4c33f37f3d1f",
      "name": "Gmail1",
      "webhookId": "d8db512f-ca78-40f0-98ff-7adc6ebbc2d8"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "831953883325563",
        "recipientPhoneNumber": "={{ $('Merge1').item.json.Destinatario }}",
        "textBody": "Parece que no tenemos el nombre exacto de este libro ahora mismo disponible, pero he avisado a un asesor para que lo compruebe.",
        "additionalFields": {
          "previewUrl": true
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1120,
        3264
      ],
      "id": "99965367-8a58-4235-904c-9956caa11558",
      "name": "Send message",
      "webhookId": "06b78f4a-474e-4d6b-98c1-dd0a40cf3e0c"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "831953883325563",
        "recipientPhoneNumber": "={{ $('Merge1').item.json.Destinatario }}",
        "textBody": "={{ $('Separador_Humanizador').item.json.messagePart }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1264,
        3488
      ],
      "id": "3399e362-b26c-4f6d-b45f-db475e7d1694",
      "name": "Enviar_mensaje",
      "webhookId": "94018992-a3d0-48a2-bba5-72feb3b079f5"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "831953883325563",
        "textBody": "={{ $now.toFormat('dd/MM/yyyy') }} {{ $now.toFormat('HH:mm:ss') }} Se ha recibido una búsqueda de libro que no se ha encontrado.  Número cliente: {{ $('Simulación_escritura').item.json.Destinatario }}  Mensaje enviado a cliente: \"{{ $('Separador_Humanizador').item.json.messagePart }}\"   Se ha procedido a enviar también un email con los detalles. Por favor atiendan esta petición.  Gracias.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1504,
        3264
      ],
      "id": "3f6ae717-e233-40f4-b93b-feae68232170",
      "name": "Mensaje Administracion",
      "webhookId": "4a344fa5-4536-413d-b74f-6e456f844db4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d13eb9a7-fae6-4906-b7ff-7a7b0c4cc08d",
                    "leftValue": "={{ $json.messages[0].audio }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voz"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messages[0].image }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "90fcac00-01b7-4992-b6b8-6cb00cda7f56"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Foto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6ef5fd99-c137-4ecb-8716-a8212a98c65e",
                    "leftValue": "={{ $json.messages[0].text.body.toString() }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5b3b5546-0bb5-4594-87fc-fa4b748cb760",
                    "leftValue": "={{ $json.messages[0].document.mime_type }}",
                    "rightValue": "=application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -4352,
        3344
      ],
      "id": "135b7eeb-2b92-4910-94da-5b5fbd415b99",
      "name": "Switch Tipo de Entrada1"
    },
    {
      "parameters": {
        "content": "## MANEJO DE  VOZ\n* Nodo de ia se encarga de traducir todo el audio y pasarlo como texto\n* Manejo de errores en caso de no entender ningun audio.",
        "height": 704,
        "width": 848
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3424,
        1904
      ],
      "typeVersion": 1,
      "id": "afa37abb-2adf-4061-bd3b-5b116d89f5e5",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].document.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -3584,
        3472
      ],
      "id": "c3b64d0c-1c70-46fc-8f47-b058c2d55f7a",
      "name": "Download media",
      "webhookId": "23e0a7a9-d602-41e8-a56a-2f5e564b5924"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3392,
        3472
      ],
      "id": "8b12bb14-471c-48e3-84aa-e68bd8c0f941",
      "name": "Descargar pdf"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -3168,
        3472
      ],
      "id": "e719eb73-67b0-4769-bd4b-07b615e7434f",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1424,
        2912
      ],
      "id": "868c06d4-a953-47ec-b12e-c2a80f744c05",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -5040,
        3600
      ],
      "id": "ca382669-3664-48d2-87ea-9d9e4c41b1c6",
      "name": "Recibir mensaje1",
      "webhookId": "40becde5-9509-41e7-9bd7-8e620cd80818"
    },
    {
      "parameters": {
        "content": "## Receptor archivo PDF\n",
        "height": 260,
        "width": 1540,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3632,
        3392
      ],
      "id": "9a63fb95-5726-4e63-9a82-ed63fb1f4bc0",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "831953883325563",
        "recipientPhoneNumber": "={{ $('Recibir mensaje1').item.json.contacts[0].wa_id }}",
        "textBody": "Lo siento puedes repetir el audio no es entendible.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -3360,
        2448
      ],
      "id": "d8f3edc5-74c1-4cd0-8944-32acf0e89241",
      "name": "Audio no entendible1",
      "webhookId": "54ff05b3-0a58-4905-afcc-c5f9b7a9378b"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -3376,
        2048
      ],
      "id": "23b196eb-52c7-4e3f-b751-757d1a8b951a",
      "name": "Descarga de Audio1",
      "webhookId": "27dc4348-d6eb-45e6-8bf7-478ee0ee4aae"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2752,
        2048
      ],
      "id": "573d0679-6b31-4ce8-b832-1c4d9f2c6b79",
      "name": "Obtener Archivo de Audio1"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -3376,
        2224
      ],
      "id": "f56d837c-ff04-400d-ad7d-6d5d1ba546b8",
      "name": "Transcribir audio a texto1",
      "credentials": {
        "openAiApi": {
          "id": "xenY6K4Lpy47eCcn",
          "name": "OpenAi ApPollos"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6fb0cb6b-8267-4073-a4c5-03f3b8724281",
              "leftValue": "={{ $json.text }}",
              "rightValue": "Subtítulos realizados por la comunidad de Amara.org",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2768,
        2224
      ],
      "id": "0f549dab-568a-45c3-bb46-bc4abb0bda24",
      "name": "Se transcribio el audio?1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c0da9ea0-b86b-49e5-abf9-53c8e3d5b152",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3088,
        2224
      ],
      "id": "572b879b-3d6c-4c5e-9a48-4de11a5a780e",
      "name": "Recepción de texto1"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3520,
        2864
      ],
      "id": "14366802-12c5-40bb-872f-366225ca314e",
      "name": "Descargar imagen1"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].image.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -3744,
        2864
      ],
      "id": "b10fd8ad-0994-4ec6-bd79-b8de34825db8",
      "name": "Obtener imagen1",
      "webhookId": "46085bb4-9128-4538-9685-3a0826c250ed"
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1312,
        3232
      ],
      "id": "488f0b43-dcf2-4ec2-8973-b20f782a9bd7",
      "name": "OpenRouter Chat Model1"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-10-21T21:35:36.780Z",
      "updatedAt": "2025-10-21T21:35:36.780Z",
      "role": "workflow:owner",
      "workflowId": "kg8MXl7tN8mCfaEJ",
      "projectId": "zIvgruNDMJwjqAqX"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-10-21T19:42:34.134Z",
      "updatedAt": "2025-10-21T19:42:34.134Z",
      "id": "8yj7B6roZf0by5Iz",
      "name": "Bible"
    },
    {
      "createdAt": "2025-10-21T19:42:07.272Z",
      "updatedAt": "2025-10-21T19:42:07.272Z",
      "id": "Ep4zoi7JSq6YdOso",
      "name": "Rodrigo De La Torre AI"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-10-25T13:15:13.000Z",
  "versionId": "c74df89d-04d6-4fd5-ab91-7bc51bc8fbd7"
}