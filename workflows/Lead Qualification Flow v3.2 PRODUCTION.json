{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Get Questions": {
      "main": [
        [
          {
            "node": "Filter Questions By Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Questions By Mode": {
      "main": [
        [
          {
            "node": "AI Data Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Data Extractor": {
      "main": [
        [
          {
            "node": "Update Multiple Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Multiple Fields": {
      "main": [
        [
          {
            "node": "Find Next Question Index",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Next Question Index": {
      "main": [
        [
          {
            "node": "Get Current Question",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Current Question": {
      "main": [
        [
          {
            "node": "IF Is Start",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Is Start": {
      "main": [
        [
          {
            "node": "Build Status Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Is City Question",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Status Payload": {
      "main": [
        [
          {
            "node": "Update Status to InProgress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status to InProgress": {
      "main": [
        [
          {
            "node": "Return Start Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Is City Question": {
      "main": [
        [
          {
            "node": "Infer Timezone",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validate & Normalize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Infer Timezone": {
      "main": [
        [
          {
            "node": "IF Needs AI Timezone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Needs AI Timezone": {
      "main": [
        [
          {
            "node": "timeZone retriver",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Timezone Payload (No AI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "timeZone retriver": {
      "main": [
        [
          {
            "node": "Parse AI Timezone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Timezone": {
      "main": [
        [
          {
            "node": "Build Timezone Payload (AI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Timezone Payload (AI)": {
      "main": [
        [
          {
            "node": "Update MongoDB (Timezone)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Timezone Payload (No AI)": {
      "main": [
        [
          {
            "node": "Update MongoDB (Timezone)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update MongoDB (Timezone)": {
      "main": [
        [
          {
            "node": "Return After Timezone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate & Normalize": {
      "main": [
        [
          {
            "node": "IF Is Valid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Is Valid": {
      "main": [
        [
          {
            "node": "Update MongoDB (Field)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update MongoDB (Field)": {
      "main": [
        [
          {
            "node": "Check If Finished",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Finished": {
      "main": [
        [
          {
            "node": "Update Question Index",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Question Index": {
      "main": [
        [
          {
            "node": "IF Questionnaire Finished",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Questionnaire Finished": {
      "main": [
        [
          {
            "node": "Build Qualified Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return Ask Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Qualified Payload": {
      "main": [
        [
          {
            "node": "Update Status to Qualified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status to Qualified": {
      "main": [
        [
          {
            "node": "Generate Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Summary": {
      "main": [
        [
          {
            "node": "IF Has Business",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Has Business": {
      "main": [
        [
          {
            "node": "Search",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify Agency (Gmail)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "timeZone retriver",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Trigger": {
      "main": [
        [
          {
            "node": "Get Questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search": {
      "main": [
        [
          {
            "node": "Summarization Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Data Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Summarization Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Summarization Chain": {
      "main": [
        [
          {
            "node": "Notify Agency (Gmail)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-19T13:20:17.309Z",
  "id": "3tPqNquDs6jC5YS8",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Lead Qualification Flow v3.2 PRODUCTION",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Define todas las preguntas en ambos idiomas\nconst QUESTIONS = {\n  \"es\": [\n    {\n      id: 0,\n      key: \"name\",\n      text: \"¬øPodr√≠as decirme tu nombre completo?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 1,\n      key: \"email\",\n      text: \"¬øCu√°l es tu correo electr√≥nico?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 2,\n      key: \"country\",\n      text: \"¬øDe qu√© pa√≠s nos contactas?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 3,\n      key: \"city\",\n      text: \"¬øEn qu√© ciudad te encuentras actualmente?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 4,\n      key: \"work_type\",\n      text: \"¬øTienes actualmente un negocio o trabajas dentro de una empresa?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 5,\n      key: \"business_name\",\n      text: \"Si tienes un negocio, ¬øc√≥mo se llama y a qu√© se dedica principalmente?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 6,\n      key: \"role\",\n      text: \"¬øCu√°l es tu rol dentro de la empresa o proyecto?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 7,\n      key: \"business_model\",\n      text: \"¬øTu empresa ofrece productos f√≠sicos, servicios, o es un negocio digital?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 8,\n      key: \"team_size\",\n      text: \"¬øCu√°ntas personas forman parte actualmente de tu equipo o negocio?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 9,\n      key: \"ai_knowledge\",\n      text: \"¬øQu√© tan familiarizado est√°s con el uso de la inteligencia artificial en tu negocio o sector?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 10,\n      key: \"main_challenge\",\n      text: \"¬øCu√°l es el principal desaf√≠o que est√°s buscando resolver ahora mismo en tu empresa?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 11,\n      key: \"past_attempt\",\n      text: \"¬øHas intentado implementar alguna herramienta o estrategia digital para resolverlo? Si es as√≠, ¬øcu√°l?\",\n      required: false,\n      blocking: false\n    }\n  ],\n  \"en\": [\n    {\n      id: 0,\n      key: \"name\",\n      text: \"Could you tell me your full name?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 1,\n      key: \"email\",\n      text: \"What's your email address?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 2,\n      key: \"country\",\n      text: \"Which country are you contacting us from?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 3,\n      key: \"city\",\n      text: \"Which city are you currently in?\",\n      required: true,\n      blocking: true\n    },\n    {\n      id: 4,\n      key: \"work_type\",\n      text: \"Do you currently have a business or work within a company?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 5,\n      key: \"business_name\",\n      text: \"If you have a business, what is its name and what does it primarily do?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 6,\n      key: \"role\",\n      text: \"What's your role within the company or project?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 7,\n      key: \"business_model\",\n      text: \"Does your company offer physical products, services, or is it a digital business?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 8,\n      key: \"team_size\",\n      text: \"How many people are currently part of your team or business?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 9,\n      key: \"ai_knowledge\",\n      text: \"How familiar are you with using artificial intelligence in your business or sector?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 10,\n      key: \"main_challenge\",\n      text: \"What is the main challenge you are looking to solve right now in your company?\",\n      required: false,\n      blocking: false\n    },\n    {\n      id: 11,\n      key: \"past_attempt\",\n      text: \"Have you tried implementing any digital tools or strategies to solve it? If so, which ones?\",\n      required: false,\n      blocking: false\n    }\n  ]\n};\n\nreturn [{ json: { questions: QUESTIONS } }];"
      },
      "id": "f00df92b-4ae1-4b0f-bb74-70152855a90d",
      "name": "Get Questions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        -80
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analiza el siguiente mensaje del usuario y extrae CUALQUIER informaci√≥n relevante para la calificaci√≥n del lead en formato JSON.\n\nMensAJE: {{ $('Trigger').item.json.message }}"
      },
      "id": "ec05d938-c472-4794-ae5d-12cee6ae1436",
      "name": "AI Data Extractor",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        -96,
        -80
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-business",
              "leftValue": "={{ $('Trigger').item.json.business_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3c8f9c8b-fef9-4bdb-bc68-eed40fe801c3",
      "name": "IF Has Business",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3520,
        48
      ]
    },
    {
      "parameters": {
        "sendTo": "empathoai@gmail.com",
        "subject": "=üöÄ Nuevo Lead Calificado: {{ $('Trigger').item.json.name }}",
        "message": "=<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <style>\n        body { font-family: 'Inter', system-ui, sans-serif; line-height: 1.6; color: #1a1a1a; margin: 0; padding: 0; background-color: #f4f7f9; }\n        .container { max-width: 600px; margin: 20px auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }\n        .header { background: #000000; padding: 30px; text-align: center; }\n        .logo { max-width: 150px; height: auto; }\n        .content { padding: 30px; }\n        .lead-badge { background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; display: inline-block; }\n        h1 { margin: 0; font-size: 24px; color: #1a1a1a; }\n        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0; border-top: 1px solid #eee; padding-top: 25px; }\n        .data-item { margin-bottom: 15px; }\n        .label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }\n        .value { font-size: 15px; font-weight: 500; color: #333; }\n        .bi-section { background: #f8f9fa; border-left: 4px solid #000; padding: 20px; margin-top: 20px; border-radius: 0 8px 8px 0; }\n        .bi-title { font-weight: 700; color: #000; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }\n        .footer { text-align: center; padding: 20px; font-size: 12px; color: #999; border-top: 1px solid #eee; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <img src=\"https://static.wixstatic.com/media/01149e_95834888a7c24bf8973b110bc9363d6b~mv2.png/v1/fill/w_404,h_102,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/dania-ai-logo.png\" alt=\"Dania AI\" class=\"logo\">\n        </div>\n        <div class=\"content\">\n            <span class=\"lead-badge\">Lead Calificado üî•</span>\n            <h1>{{ $('Trigger').item.json.name }}</h1>\n            \n            <div class=\"data-grid\">\n                <div class=\"data-item\">\n                    <div class=\"label\">Email</div>\n                    <div class=\"value\">{{ $('Trigger').item.json.email }}</div>\n                </div>\n                <div class=\"data-item\">\n                    <div class=\"label\">Ubicaci√≥n</div>\n                    <div class=\"value\">{{ $('Trigger').item.json.city }}, {{ $('Trigger').item.json.country }} ({{ $('Trigger').item.json.timezone }})</div>\n                </div>\n                <div class=\"data-item\">\n                    <div class=\"label\">Negocio</div>\n                    <div class=\"value\">{{ $('Trigger').item.json.business_name || 'N/A' }}</div>\n                </div>\n                <div class=\"data-item\">\n                    <div class=\"label\">Modelo</div>\n                    <div class=\"value\">{{ $('Trigger').item.json.business_model || 'N/A' }}</div>\n                </div>\n            </div>\n\n            <div class=\"data-item\">\n                <div class=\"label\">Desaf√≠o Principal</div>\n                <div class=\"value\">{{ $('Trigger').item.json.main_challenge }}</div>\n            </div>\n\n            {{#if $node[\"Summarization Chain\"]}}\n            <div class=\"bi-section\">\n                <div class=\"bi-title\">üïµÔ∏è Inteligencia Estrat√©gica (Tavily AI)</div>\n                <div class=\"value\">{{ $node[\"Summarization Chain\"].json.text }}</div>\n            </div>\n            {{/if}}\n        </div>\n        <div class=\"footer\">\n            &copy; 2026 Empatho AI Agency | Dania Assistant Intelligence System\n        </div>\n    </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "be095986-ff6c-47fe-9b05-cfd1199df183",
      "name": "Notify Agency (Gmail)",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        4320,
        80
      ],
      "webhookId": "ea482e6a-26e5-41d3-a185-1b4fff9e2f10",
      "credentials": {
        "gmailOAuth2": {
          "id": "lJvypbA2AJhKcdY5",
          "name": "Gmail API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Filtra preguntas seg√∫n idioma y modo\nconst lang = $('Trigger').item.json.language || 'es';\nconst mode = $('Trigger').item.json.mode || 'full';\nconst allQuestions = $('Get Questions').item.json.questions;\n\nconst localized = allQuestions[lang];\n\nconst filtered = mode === 'minimal'\n  ? localized.filter(q => q.required)\n  : localized;\n\nreturn [{\n  json: {\n    questions: filtered,\n    total_questions: filtered.length,\n    mode: mode,\n    language: lang\n  }\n}];"
      },
      "id": "1a7e3ebe-f184-4af9-b77e-0260f22e26c0",
      "name": "Filter Questions By Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -320,
        -80
      ]
    },
    {
      "parameters": {
        "jsCode": "// Obtiene la pregunta actual seg√∫n el √≠ndice\n// MEJORADO: Detecta si es INICIO del cuestionario o CONTINUACI√ìN\nconst triggerData = $('Trigger').item.json;\nconst filterData = $('Filter Questions By Mode').item.json;\n\nconst questions = filterData.questions || [];\nconst index = triggerData.current_question_index ?? 0;\nconst sessionId = triggerData.sessionId;\nconst message = (triggerData.message || '').toLowerCase();\n\nif (!Array.isArray(questions) || questions.length === 0) {\n  return [{\n    json: {\n      error: 'No questions found',\n      sessionId,\n      current_index: index,\n    }\n  }];\n}\n\nconst currentQuestion = questions[index];\n\n// L√ìGICA DE DETECCI√ìN DE INICIO:\n// Solo es inicio si:\n// 1. index=0 (primera pregunta)\n// 2. name est√° vac√≠o (no ha respondido nada)\n// 3. El mensaje contiene palabras clave de intenci√≥n (quiero, agendar, cita, etc)\n//    o es una opci√≥n del men√∫ (1, 2, 3)\n\nconst startKeywords = /quiero|agendar|agenda|cita|informaci√≥n|servicios|s√≠.*quiero|si.*quiero|^1$|^2$|^3$/i;\nconst isStartKeyword = startKeywords.test(message);\nconst isStartOfQuestionnaire = (index === 0 && !triggerData.name && isStartKeyword);\n\nconsole.log('[Get Current Question] Analysis:', { index, hasName: !!triggerData.name, message, isStartKeyword, isStartOfQuestionnaire });\n\nif (isStartOfQuestionnaire) {\n  // Primera llamada - retornar primera pregunta sin intentar validar el message\n  console.log('[Get Current Question] INICIO de cuestionario - retornando primera pregunta');\n  return [{\n    json: {\n      action: 'ask',\n      next_question: currentQuestion.text,\n      current_question_index: 0,\n      sessionId,\n      finished: false,\n      _mode: 'start'\n    }\n  }];\n}\n\n// Continuaci√≥n normal - el message es respuesta a la pregunta actual\nconsole.log('[Get Current Question] CONTINUACI√ìN - procesando respuesta para:', currentQuestion.key);\nreturn [{\n  json: {\n    ...currentQuestion,\n    current_index: index,\n    sessionId,\n    _mode: 'continue'\n  }\n}];"
      },
      "id": "b72f133e-21bc-4528-9698-eda149bb6d23",
      "name": "Get Current Question",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        704,
        -80
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "city-check",
              "leftValue": "={{ $json.key }}",
              "rightValue": "city",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ff666d52-d435-4d3f-82e2-044e4628072b",
      "name": "IF Is City Question",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        32
      ]
    },
    {
      "parameters": {
        "jsCode": "// Inferencia de timezone con cache nativo\nconst cache = this.getWorkflowStaticData('global');\n\n// Funci√≥n de normalizaci√≥n\nconst normalize = s => s.normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g,\"\").trim().toUpperCase();\n\n// Obtener datos\nconst leadData = $('Trigger').item.json;\nconst country = normalize(leadData.country || \"\");\nconst city = normalize($('Trigger').item.json.message);\nconst cacheKey = `${country}_${city}`;\n\nconsole.log('[Timezone] Checking:', { country, city, cacheKey });\n\n// Check cache primero\nif (cache[cacheKey]) {\n  console.log('[Timezone] Cache HIT:', cache[cacheKey]);\n  return [{\n    json: {\n      timezone: cache[cacheKey],\n      from_cache: true,\n      needs_ai: false,\n      country: country,\n      city: city,\n      sessionId: $('Get Current Question').item.json.sessionId\n    }\n  }];\n}\n\n// Mapa local de zonas horarias (LATAM + Espa√±a + NZ)\nconst TIMEZONE_MAP = {\n  \"MEXICO\": {\n    \"GUADALAJARA\": \"America/Mexico_City\",\n    \"MONTERREY\": \"America/Monterrey\",\n    \"TIJUANA\": \"America/Tijuana\",\n    \"CANCUN\": \"America/Cancun\",\n    \"CIUDAD DE MEXICO\": \"America/Mexico_City\",\n    \"CDMX\": \"America/Mexico_City\",\n    \"MERIDA\": \"America/Merida\",\n    \"PUEBLA\": \"America/Mexico_City\",\n    \"QUERETARO\": \"America/Mexico_City\",\n    \"JALISCO\": \"America/Mexico_City\",\n    \"NUEVO LEON\": \"America/Monterrey\",\n    \"ESTADO DE MEXICO\": \"America/Mexico_City\",\n    \"YUCATAN\": \"America/Merida\"\n  },\n  \"COLOMBIA\": {\n    \"BOGOTA\": \"America/Bogota\",\n    \"MEDELLIN\": \"America/Bogota\",\n    \"CALI\": \"America/Bogota\",\n    \"BARRANQUILLA\": \"America/Bogota\",\n    \"CARTAGENA\": \"America/Bogota\",\n    \"ANTIOQUIA\": \"America/Bogota\"\n  },\n  \"ESPA√ëA\": {\n    \"MADRID\": \"Europe/Madrid\",\n    \"BARCELONA\": \"Europe/Madrid\",\n    \"VALENCIA\": \"Europe/Madrid\",\n    \"SEVILLA\": \"Europe/Madrid\",\n    \"BILBAO\": \"Europe/Madrid\"\n  },\n  \"SPAIN\": {\n    \"MADRID\": \"Europe/Madrid\",\n    \"BARCELONA\": \"Europe/Madrid\"\n  },\n  \"ARGENTINA\": {\n    \"BUENOS AIRES\": \"America/Argentina/Buenos_Aires\",\n    \"CORDOBA\": \"America/Argentina/Cordoba\",\n    \"ROSARIO\": \"America/Argentina/Cordoba\",\n    \"MENDOZA\": \"America/Argentina/Mendoza\"\n  },\n  \"BRASIL\": {\n    \"SAO PAULO\": \"America/Sao_Paulo\",\n    \"RIO DE JANEIRO\": \"America/Sao_Paulo\",\n    \"BRASILIA\": \"America/Sao_Paulo\",\n    \"SALVADOR\": \"America/Bahia\",\n    \"FORTALEZA\": \"America/Fortaleza\"\n  },\n  \"BRAZIL\": {\n    \"SAO PAULO\": \"America/Sao_Paulo\",\n    \"RIO DE JANEIRO\": \"America/Sao_Paulo\"\n  },\n  \"CHILE\": {\n    \"SANTIAGO\": \"America/Santiago\",\n    \"VALPARAISO\": \"America/Santiago\"\n  },\n  \"PERU\": {\n    \"LIMA\": \"America/Lima\",\n    \"AREQUIPA\": \"America/Lima\"\n  },\n  \"ECUADOR\": {\n    \"QUITO\": \"America/Guayaquil\",\n    \"GUAYAQUIL\": \"America/Guayaquil\"\n  },\n  \"NEW ZEALAND\": {\n    \"AUCKLAND\": \"Pacific/Auckland\",\n    \"WELLINGTON\": \"Pacific/Auckland\"\n  }\n};\n\n// Buscar en mapa local\nconst timezone = TIMEZONE_MAP[country]?.[city] || null;\n\nif (timezone) {\n  // Guardar en cache\n  cache[cacheKey] = timezone;\n  console.log('[Timezone] Local DB HIT:', timezone);\n  \n  return [{\n    json: {\n      timezone: timezone,\n      from_cache: false,\n      needs_ai: false,\n      country: country,\n      city: city,\n      sessionId: $('Get Current Question').item.json.sessionId\n    }\n  }];\n}\n\n// No encontrado - necesita AI\nconsole.log('[Timezone] Local DB MISS - needs AI');\nreturn [{\n  json: {\n    timezone: null,\n    from_cache: false,\n    needs_ai: true,\n    country: country,\n    city: city,\n    sessionId: $('Get Current Question').item.json.sessionId\n  }\n}];"
      },
      "id": "a3806288-c96c-4b47-a021-9084428b95a3",
      "name": "Infer Timezone",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1376,
        -272
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "needs-ai-check",
              "leftValue": "={{ $json.needs_ai }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5c599c90-64e7-4ee9-b77a-df33dc1dead0",
      "name": "IF Needs AI Timezone",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1600,
        -272
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response con error handling robusto\nconst cache = this.getWorkflowStaticData('global');\nconst country = $('Infer Timezone').item.json.country;\nconst city = $('Infer Timezone').item.json.city;\nconst cacheKey = `${country}_${city}`;\n\nlet timezone = \"UNDEFINED\";\n\ntry {\n  // El output de OpenAI puede venir en diferentes formatos\n  const aiOutput = $input.item.json.output || $input.item.json.text || $input.item.json.response || \"\";\n  \n  console.log('[AI Timezone] Raw output:', aiOutput);\n  \n  // Limpiar markdown si existe\n  const cleanOutput = aiOutput.replace(/```json|```/g, \"\").trim();\n  \n  // Intentar parsear JSON\n  const parsed = JSON.parse(cleanOutput);\n  timezone = parsed.timezone || \"UNDEFINED\";\n  \n  console.log('[AI Timezone] Parsed timezone:', timezone);\n  \n} catch (error) {\n  console.error('[AI Timezone] Parse error:', error.message);\n  timezone = \"UNDEFINED\";\n}\n\n// Guardar en cache solo si es v√°lido\nif (timezone && timezone !== \"UNDEFINED\") {\n  cache[cacheKey] = timezone;\n  console.log('[AI Timezone] Cached:', { cacheKey, timezone });\n}\n\nreturn [{\n  json: {\n    timezone: timezone,\n    from_cache: false,\n    from_ai: true,\n    country: country,\n    city: city,\n    sessionId: $('Infer Timezone').item.json.sessionId\n  }\n}];"
      },
      "id": "10e67fd1-af5b-4e73-9aef-bfafa3344f15",
      "name": "Parse AI Timezone",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2176,
        -400
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "leads",
        "updateKey": "sessionId",
        "fields": "timezone,city,country",
        "options": {}
      },
      "id": "a944605c-86fc-40bd-975d-00d549a8ee06",
      "name": "Update MongoDB (Timezone)",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        2624,
        -272
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "KNCVFnX6uXTL664z",
          "name": "MongoDB n8n"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Preparar respuesta para el orquestador (skip_wait para city)\nconst questions = $('Filter Questions By Mode').item.json.questions;\nconst currentIndex = $('Get Current Question').item.json.current_index;\nconst totalQuestions = questions.length;\nconst newIndex = currentIndex + 1;\n\n// Verificar si termin√≥\nif (newIndex >= totalQuestions) {\n  return [{\n    json: {\n      action: \"summary\",\n      finished: true,\n      sessionId: $json.sessionId\n    }\n  }];\n}\n\n// Obtener siguiente pregunta\nconst nextQuestion = questions[newIndex];\n\nreturn [{\n  json: {\n    action: \"ask\",\n    next_question: nextQuestion.text,\n    finished: false,\n    sessionId: $json.sessionId,\n    current_question_index: newIndex\n  }\n}];"
      },
      "id": "61ff40ce-c0e7-464b-a980-2c7d47179a2f",
      "name": "Return After Timezone",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2848,
        -272
      ]
    },
    {
      "parameters": {
        "jsCode": "// Validar y normalizar respuesta del usuario\nconst key = $('Get Current Question').item.json.key;\nconst blocking = $('Get Current Question').item.json.blocking;\nconst userMessage = $('Trigger').item.json.message || \"\";\nconst msg = userMessage.trim();\nlet normalized = msg;\n\nconsole.log('[Validate] Field:', key, 'Message:', msg, 'Blocking:', blocking);\n\n// ===== DETECCI√ìN DE SALTO (SKIP) PARA CAMPOS NO BLOQUEANTES =====\nconst skipKeywords = /saltar|paso|no.*se|prefiero.*no|skip|n\\/a|omitir/i;\nif (!blocking && skipKeywords.test(msg)) {\n  console.log('[Validate] Optional field skipped by user');\n  return [{\n    json: {\n      action: \"valid\",\n      key: key,\n      value: \"No proporcionado\",\n      sessionId: $('Get Current Question').item.json.sessionId\n    }\n  }];\n}\n\n// ===== VALIDACI√ìN DE NOMBRE =====\nif (key === \"name\") {\n  normalized = msg.toUpperCase().replace(/\\s+/g, \" \").trim();\n  \n  const words = normalized.split(\" \");\n  if (words.length < 2) {\n    console.log('[Validate] Name error: menos de 2 palabras');\n    return [{\n      json: {\n        action: \"error\",\n        error_msg: \"Por favor ingresa tu nombre completo (nombre y apellido).\",\n        sessionId: $('Get Current Question').item.json.sessionId\n      }\n    }];\n  }\n}\n\n// ===== VALIDACI√ìN DE EMAIL =====\nif (key === \"email\") {\n  normalized = msg.toLowerCase().trim();\n  \n  // 1. Validar que tenga @ (CR√çTICO)\n  if (!normalized.includes('@')) {\n    console.log('[Validate] Email error: sin @');\n    return [{\n      json: {\n        action: \"error\",\n        error_msg: \"El email debe contener el s√≠mbolo @\",\n        sessionId: $('Get Current Question').item.json.sessionId\n      }\n    }];\n  }\n  \n  // 2. Split seguro\n  const [user, domain] = normalized.split('@');\n  \n  // 3. Validar que ambas partes existan (FIX v3.1)\n  if (!user || !domain) {\n    console.log('[Validate] Email error: user o domain vac√≠o');\n    return [{\n      json: {\n        action: \"error\",\n        error_msg: \"Formato de email inv√°lido\",\n        sessionId: $('Get Current Question').item.json.sessionId\n      }\n    }];\n  }\n  \n  // 4. Detecci√≥n de typos\n  const typos = {\n    'gmai.com': 'gmail.com',\n    'gmial.com': 'gmail.com',\n    'gmil.com': 'gmail.com',\n    'hotmai.com': 'hotmail.com',\n    'hotmial.com': 'hotmail.com',\n    'outlok.com': 'outlook.com',\n    'outlool.com': 'outlook.com',\n    'yaho.com': 'yahoo.com',\n    'yahooo.com': 'yahoo.com',\n    'iclou.com': 'icloud.com',\n    'icoud.com': 'icloud.com'\n  };\n  \n  if (typos[domain]) {\n    console.log('[Validate] Email typo detected:', domain, '->', typos[domain]);\n    return [{\n      json: {\n        action: \"error\",\n        error_msg: `¬øQuisiste decir ${user}@${typos[domain]}?`,\n        sessionId: $('Get Current Question').item.json.sessionId\n      }\n    }];\n  }\n  \n  // 5. Validaci√≥n RFC 5322\n  const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n  \n  if (!emailRegex.test(normalized)) {\n    console.log('[Validate] Email error: formato inv√°lido');\n    return [{\n      json: {\n        action: \"error\",\n        error_msg: \"El formato del correo electr√≥nico no es v√°lido\",\n        sessionId: $('Get Current Question').item.json.sessionId\n      }\n    }];\n  }\n}\n\n// ===== NORMALIZACI√ìN DE COUNTRY/CITY =====\nif (key === \"country\" || key === \"city\") {\n  normalized = msg.toUpperCase().trim();\n}\n\n// ===== NORMALIZACI√ìN DE OTROS CAMPOS =====\nif (![\"name\", \"email\", \"country\", \"city\"].includes(key)) {\n  // Title Case para campos de texto libre\n  normalized = msg.toLowerCase().split(' ')\n    .map(w => w.charAt(0).toUpperCase() + w.slice(1))\n    .join(' ');\n}\n\nconsole.log('[Validate] Success:', { key, normalized });\n\nreturn [{\n  json: {\n    action: \"valid\",\n    key: key,\n    value: normalized,\n    sessionId: $('Get Current Question').item.json.sessionId\n  }\n}];"
      },
      "id": "b2cfa36e-c2cf-467f-8820-155b752aaa7a",
      "name": "Validate & Normalize",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1376,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "valid-check",
              "leftValue": "={{ $json.action }}",
              "rightValue": "valid",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "8cc2b679-46e2-48eb-a74b-f907d5682c3e",
      "name": "IF Is Valid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1600,
        240
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "leads",
        "updateKey": "sessionId",
        "fields": "={{ Object.keys($json).filter(k => k !== 'sessionId' && k !== 'action').join(',') }}",
        "options": {}
      },
      "id": "7ded179a-6d01-446b-b475-52b9283f905f",
      "name": "Update MongoDB (Field)",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        1888,
        144
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "KNCVFnX6uXTL664z",
          "name": "MongoDB n8n"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Incrementar √≠ndice y verificar si termin√≥ el cuestionario\n// FIXED: Always include current_question_index in output for persistence\nconst questions = $('Filter Questions By Mode').item.json.questions;\nconst currentIndex = $('Get Current Question').item.json.current_index;\nconst totalQuestions = questions.length;\nconst newIndex = currentIndex + 1;\n\nconst sessionId =\n  $json.sessionId ||\n  $('Get Current Question').item.json.sessionId ||\n  $('Trigger').item.json.sessionId;\n\nconsole.log('[Check Finished]', { currentIndex, newIndex, totalQuestions });\n\n// Verificar si termin√≥\nif (newIndex >= totalQuestions) {\n  console.log('[Check Finished] Cuestionario completado');\n  return [{\n    json: {\n      action: \"summary\",\n      finished: true,\n      sessionId,\n      current_question_index: newIndex  // CRITICAL: Include for MongoDB update\n    }\n  }];\n}\n\n// Obtener siguiente pregunta\nconst nextQuestion = questions[newIndex];\n\nconsole.log('[Check Finished] Siguiente pregunta:', nextQuestion.text);\n\nreturn [{\n  json: {\n    action: \"ask\",\n    next_question: nextQuestion.text,\n    finished: false,\n    sessionId,\n    current_question_index: newIndex  // CRITICAL: Include for MongoDB update\n  }\n}];"
      },
      "id": "ecbfe0df-6417-4d71-b8c3-3d25acbf4443",
      "name": "Check If Finished",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2176,
        144
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": ""
          },
          "conditions": [
            {
              "id": "finished-check",
              "leftValue": "={{ $json.action }}",
              "rightValue": "summary",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b89f5593-5e00-455d-af27-c9ffae526f85",
      "name": "IF Questionnaire Finished",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2624,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "// Generar resumen seg√∫n modo (full o minimal)\nconst leadData = $('Trigger').item.json;\nconst mode = $('Filter Questions By Mode').item.json.mode;\nconst lang = $('Filter Questions By Mode').item.json.language;\n\nconst templates = {\n  es: {\n    header: \"Perfecto, esto es lo que tengo:\\n\\n\",\n    footer: \"\\n\\n¬øConfirmas que todo es correcto? (Responde S√≠ o No)\",\n    fields: {\n      name: \"üë§ Nombre: \",\n      email: \"üìß Email: \",\n      country: \"üåç Pa√≠s: \",\n      city: \"üèôÔ∏è Ciudad: \",\n      timezone: \"üïì Zona Horaria: \",\n      work_type: \"üè¢ Tipo de trabajo: \",\n      business_name: \"üíº Negocio: \",\n      role: \"üëî Rol: \",\n      business_model: \"üí° Modelo: \",\n      team_size: \"üë• Equipo: \",\n      ai_knowledge: \"ü§ñ Conocimiento de IA: \",\n      main_challenge: \"‚öôÔ∏è Desaf√≠o: \",\n      past_attempt: \"üß† Intentos previos: \"\n    }\n  },\n  en: {\n    header: \"Perfect, here's what I have:\\n\\n\",\n    footer: \"\\n\\nDo you confirm everything is correct? (Reply Yes or No)\",\n    fields: {\n      name: \"üë§ Name: \",\n      email: \"üìß Email: \",\n      country: \"üåç Country: \",\n      city: \"üèôÔ∏è City: \",\n      timezone: \"üïì Timezone: \",\n      work_type: \"üè¢ Work type: \",\n      business_name: \"üíº Business: \",\n      role: \"üëî Role: \",\n      business_model: \"üí° Model: \",\n      team_size: \"üë• Team: \",\n      ai_knowledge: \"ü§ñ AI knowledge: \",\n      main_challenge: \"‚öôÔ∏è Challenge: \",\n      past_attempt: \"üß† Past attempts: \"\n    }\n  }\n};\n\nconst t = templates[lang] || templates['es'];\nlet summary = t.header;\n\n// Campos obligatorios (siempre en ambos modos)\nconst requiredFields = ['name', 'email', 'country', 'city', 'timezone'];\nfor (const field of requiredFields) {\n  if (leadData[field]) {\n    summary += t.fields[field] + leadData[field] + \"\\n\";\n  }\n}\n\n// Campos opcionales (solo en modo full)\nif (mode === 'full') {\n  const optionalFields = [\n    'work_type', 'business_name', 'role', 'business_model',\n    'team_size', 'ai_knowledge', 'main_challenge', 'past_attempt'\n  ];\n  \n  for (const field of optionalFields) {\n    if (leadData[field]) {\n      summary += t.fields[field] + leadData[field] + \"\\n\";\n    }\n  }\n}\n\nsummary += t.footer;\n\nconsole.log('[Summary] Generated:', { mode, lang });\n\nreturn [{\n  json: {\n    action: \"summary\",\n    summary: summary,\n    finished: true,\n    mode: mode,\n    sessionId: leadData.sessionId\n  }\n}];"
      },
      "id": "01f0e20c-606e-4c2a-9293-0b49413fb385",
      "name": "Generate Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3296,
        48
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "return-error",
              "name": "action",
              "value": "={{ $json.action }}",
              "type": "string"
            },
            {
              "id": "return-error-msg",
              "name": "error_msg",
              "value": "={{ $json.error_msg }}",
              "type": "string"
            },
            {
              "id": "return-finished",
              "name": "finished",
              "value": "=false",
              "type": "boolean"
            },
            {
              "id": "return-session",
              "name": "sessionId",
              "value": "={{ $json.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "41c263d1-7b35-4762-9c95-89fbaaf6b8c2",
      "name": "Return Error Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1888,
        336
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "return-action",
              "name": "action",
              "value": "={{ $json.action }}",
              "type": "string"
            },
            {
              "id": "return-question",
              "name": "next_question",
              "value": "={{ $json.next_question }}",
              "type": "string"
            },
            {
              "id": "return-finished-ask",
              "name": "finished",
              "value": "=false",
              "type": "boolean"
            },
            {
              "id": "return-index",
              "name": "current_question_index",
              "value": "={{ $json.current_question_index }}",
              "type": "number"
            },
            {
              "id": "return-session-ask",
              "name": "sessionId",
              "value": "={{ $json.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "45f66b4a-e399-4158-ac3a-fac32c023f9c",
      "name": "Return Ask Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2848,
        240
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {
          "webSearch": {
            "searchContextSize": "low"
          }
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        1904,
        -176
      ],
      "id": "4fd9d8a2-ddf8-4966-9dc4-68a365529da2",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "si6kdb1qPc1J6iuX",
          "name": "OpenAi Supabase Hybrid"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Given the following location details, return the most accurate IANA timezone name.\n\nCountry: {{ $json.country }}\nCity: {{ $json.city }}\n\nRemember:\n- Use your internal knowledge and web search if needed.\n- Respond **only** with valid JSON like this:\n{\"timezone\": \"America/Mexico_City\"}\n- If you cannot find a valid match, return:\n{\"timezone\": \"UNDEFINED\"}\n",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1824,
        -400
      ],
      "id": "c32c840c-ba46-42c4-98c9-828b6cc5b7ef",
      "name": "timeZone retriver"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "sessionId"
            },
            {
              "name": "name"
            },
            {
              "name": "email"
            },
            {
              "name": "country"
            },
            {
              "name": "city"
            },
            {
              "name": "work_type"
            },
            {
              "name": "business_name"
            },
            {
              "name": "role"
            },
            {
              "name": "business_model"
            },
            {
              "name": "team_size"
            },
            {
              "name": "ai_knowledge"
            },
            {
              "name": "main_challenge"
            },
            {
              "name": "past_attempt"
            },
            {
              "name": "timezone"
            },
            {
              "name": "language"
            },
            {
              "name": "current_question_index"
            },
            {
              "name": "status"
            },
            {
              "name": "total_questions",
              "type": "number"
            },
            {
              "name": "mode"
            },
            {
              "name": "message"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -768,
        -80
      ],
      "id": "1911c3c0-09e7-42c2-b0c7-cbd694a8fba2",
      "name": "Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Build payload para timezone con AI\nconst data = $json;\nreturn [{\n  json: {\n    sessionId: data.sessionId,\n    timezone: data.timezone || null,\n    city: data.city || null,\n    country: data.country || null\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        -400
      ],
      "id": "59520e77-a543-4f77-817f-fff2d17b186c",
      "name": "Build Timezone Payload (AI)"
    },
    {
      "parameters": {
        "jsCode": "// Build payload para timezone sin AI\nconst data = $json;\nreturn [{\n  json: {\n    sessionId: data.sessionId,\n    timezone: data.timezone || null,\n    city: data.city || null,\n    country: data.country || null\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        -144
      ],
      "id": "36afef24-5a98-495d-a2ff-285223e7e7d7",
      "name": "Build Timezone Payload (No AI)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "is-start-check",
              "leftValue": "={{ $json._mode }}",
              "rightValue": "start",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a1fd01a8-4b50-4395-b0f3-af3542534ab9",
      "name": "IF Is Start",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        928,
        -80
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "leads",
        "updateKey": "sessionId",
        "fields": "status,mode",
        "options": {}
      },
      "id": "72ccf2d1-52e3-4f90-b147-90a939288d9a",
      "name": "Update Status to InProgress",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        1376,
        -464
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "KNCVFnX6uXTL664z",
          "name": "MongoDB n8n"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepara payload para actualizar status al iniciar cuestionario\n// Y tambi√©n prepara los datos de respuesta para retornar la primera pregunta\nconst data = $json;\nreturn [{\n  json: {\n    sessionId: data.sessionId,\n    status: 'in_progress',\n    mode: 'full',\n    // Response fields para retornar despu√©s del update\n    _response: {\n      action: data.action,\n      next_question: data.next_question,\n      current_question_index: data.current_question_index,\n      finished: data.finished,\n      sessionId: data.sessionId\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        -464
      ],
      "id": "79af64b5-78e3-488f-91ac-02a200041de2",
      "name": "Build Status Payload"
    },
    {
      "parameters": {
        "jsCode": "// Retorna la respuesta de inicio de cuestionario despu√©s de actualizar status\nconst data = $('Build Status Payload').item.json._response;\nreturn [{\n  json: {\n    action: data.action,\n    next_question: data.next_question,\n    current_question_index: data.current_question_index,\n    finished: data.finished,\n    sessionId: data.sessionId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        -464
      ],
      "id": "e97ae7e5-3ccd-4889-a9f8-7abf7fdff846",
      "name": "Return Start Response"
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "leads",
        "updateKey": "sessionId",
        "fields": "current_question_index",
        "options": {}
      },
      "id": "f27c45a1-41a6-41ff-aaaf-634ab8555cec",
      "name": "Update Question Index",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        2400,
        144
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "KNCVFnX6uXTL664z",
          "name": "MongoDB n8n"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Preparar payload para marcar el lead como calificado\nconst data = $json;\nreturn [{\n  json: {\n    sessionId: data.sessionId,\n    status: 'qualified'\n  }\n}];"
      },
      "id": "66c7fca9-1665-4f76-8c1b-87ffdf3e2117",
      "name": "Build Qualified Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2848,
        48
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "leads",
        "updateKey": "sessionId",
        "fields": "status",
        "options": {}
      },
      "id": "70623b51-003c-431d-a9dc-011475121045",
      "name": "Update Status to Qualified",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        3072,
        48
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "KNCVFnX6uXTL664z",
          "name": "MongoDB n8n"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "leads",
        "updateKey": "sessionId",
        "fields": "={{ $json.text }}",
        "options": {}
      },
      "id": "69eb1d88-918a-4629-9bc7-3dab2fca770c",
      "name": "Update Multiple Fields",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.1,
      "position": [
        256,
        -80
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "KNCVFnX6uXTL664z",
          "name": "MongoDB n8n"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Escanea los datos actuales y encuentra la primera pregunta vac√≠a\nconst lead = $('Trigger').item.json;\nconst aiOutput = $('AI Data Extractor').item.json.output || '{}';\nconst questions = $('Filter Questions By Mode').item.json.questions;\n\nlet extracted = {};\ntry {\n  extracted = typeof aiOutput === 'string' ? JSON.parse(aiOutput) : aiOutput;\n} catch (e) { \n  console.error('[Find Next Empty] AI Parse Error:', e.message);\n}\n\n// Merge lead con los nuevos datos extra√≠dos\nconst currentData = { ...lead, ...extracted };\n\n// Buscar primer √≠ndice vac√≠o\nlet nextIndex = 0;\nfor (let i = 0; i < questions.length; i++) {\n  const key = questions[i].key;\n  if (!currentData[key] || currentData[key] === 'No proporcionado') {\n    nextIndex = i;\n    break;\n  }\n  // Si llegamos al final y ninguno est√° vac√≠o\n  if (i === questions.length - 1) nextIndex = questions.length;\n}\n\nreturn [{\n  json: {\n    next_index: nextIndex,\n    finished: nextIndex >= questions.length,\n    next_question: nextIndex < questions.length ? questions[nextIndex].text : null,\n    sessionId: lead.sessionId,\n    extracted_data: extracted // Pasamos esto para el Update MongoDB\n  }\n}];"
      },
      "id": "dc8fee73-fa5d-4ec1-911c-a1fc67279a05",
      "name": "Find Next Question Index",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        480,
        -80
      ]
    },
    {
      "parameters": {
        "query": "=Informaci√≥n corporativa de {{ $('Trigger').item.json.business_name }}",
        "options": {
          "search_depth": "basic"
        }
      },
      "type": "@tavily/n8n-nodes-tavily.tavily",
      "typeVersion": 1,
      "position": [
        3744,
        -80
      ],
      "id": "5c31be3a-df9f-4bf4-a9c5-d26354a947af",
      "name": "Search",
      "credentials": {
        "tavilyApi": {
          "id": "W0dexWLOaXVQdDMP",
          "name": "Tavily"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "responsesApiEnabled": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -32,
        160
      ],
      "id": "5431da9f-8219-4a45-b5d4-104f4bbcf858",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "si6kdb1qPc1J6iuX",
          "name": "OpenAi Supabase Hybrid"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "responsesApiEnabled": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        3904,
        176
      ],
      "id": "1a829022-9ddf-41b6-878c-76013b6b457a",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "si6kdb1qPc1J6iuX",
          "name": "OpenAi Supabase Hybrid"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainSummarization",
      "typeVersion": 2.1,
      "position": [
        3984,
        -80
      ],
      "id": "2bb1f434-cbc3-42ba-85d3-9aa9d95b6721",
      "name": "Summarization Chain"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2026-01-19T13:20:17.314Z",
      "createdAt": "2026-01-19T13:20:17.314Z",
      "role": "workflow:owner",
      "workflowId": "3tPqNquDs6jC5YS8",
      "projectId": "zIvgruNDMJwjqAqX"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-21T10:31:24.000Z",
  "versionId": "b7c875d4-77fe-4b40-b74f-c1c3e7c8a5bb"
}