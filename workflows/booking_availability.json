{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Sugerir Horarios Cercanos": {
      "main": [
        [
          {
            "node": "Huecos libres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mirar Disponibilidad": {
      "main": [
        [
          {
            "node": "Are Slots Available",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Comienzo y Final": {
      "main": [
        [
          {
            "node": "Mirar Disponibilidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Are Slots Available": {
      "main": [
        [
          {
            "node": "Sugerir Horarios Cercanos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No hay huecos libres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Elegir Herramienta": {
      "main": [
        [
          {
            "node": "Comienzo y Final",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agendar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Setear Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agendar Cita": {
      "main": [
        [
          {
            "node": "Cita agendada con exito",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cita no agendada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setear Variables": {
      "main": [
        [
          {
            "node": "Elegir Herramienta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-11-05T21:08:32.318Z",
  "id": "KTdNVJBTrV4GXBkj",
  "isArchived": false,
  "meta": null,
  "name": "booking_availability",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// --- FUNCIÓN PARA FORMATEAR HORA ---\nfunction formatoHoraEspañol(dateTime) {\n  const hora = dateTime.hour;\n  const minuto = dateTime.minute;\n  const minutoStr = minuto === 0 ? '' : `:${minuto.toString().padStart(2, '0')}`;\n  let horaDoce = hora % 12; if (horaDoce === 0) horaDoce = 12;\n  let periodo = (hora < 12) ? \" de la mañana\" : (hora < 20) ? \" de la tarde\" : \" de la noche\";\n  return (horaDoce === 1) ? `La 1${minutoStr}${periodo}` : `Las ${horaDoce}${minutoStr}${periodo}`;\n}\n\n// --- 1) INPUT + TZ ---\nconst args = $('Webhook').item.json.body.message.toolCalls[0].function.arguments;\nconst TZ = args.zonaHoraria || 'Europe/Madrid';\nconst citaSolicitadaISO = args.citaSolicitada;\nconst req = DateTime.fromISO(citaSolicitadaISO).setZone(TZ).startOf('minute');\nconst reqMillisUTC = req.toUTC().toMillis();\n\n// --- 2) SLOTS DE LA API (solo el MISMO DÍA) ---\nconst data = $('Mirar Disponibilidad').item.json.data || {};\nconst sameDayKey = req.toISODate(); // p.ej. \"2025-09-09\"\nconst rawSlots = data[sameDayKey] || [];\nconst slots = rawSlots.map(s => DateTime.fromISO(s.start).setZone(TZ).startOf('minute'));\n\n// --- 3) ¿ESTÁ DISPONIBLE EXACTO? (comparación robusta) ---\nconst isAvailable = slots.some(dt => dt.toUTC().toMillis() === reqMillisUTC);\n\n// --- 4) MENSAJE + SUGERENCIAS (2 más cercanas del MISMO DÍA) ---\nlet message = \"\";\nif (isAvailable) {\n  message = \"Sí, ese horario está disponible. ¿Quieres que te agende la cita?\";\n} else if (slots.length > 0) {\n  const sugerencias = slots\n    .map(dt => ({ dt, diff: Math.abs(dt.toMillis() - req.toMillis()) }))\n    .sort((a, b) => a.diff - b.diff)\n    .slice(0, 2)\n    .map(x => formatoHoraEspañol(x.dt));\n  message = `Vaya, la hora que solicitaste no está disponible. Pero tengo estos horarios cercanos: ${sugerencias.join(' y ')}. ¿Te gustaría reservar alguno de ellos?`;\n} else {\n  message = \"Lo siento, no he encontrado ningún hueco disponible para ese día. ¿Quieres intentar con otra fecha?\";\n}\n\n// --- 5) SALIDA ---\nreturn [{\n  json: {\n    isAvailable,\n    message\n    // opcional debug:\n    // requested: req.toISO(),\n    // slots: slots.map(s => s.toISO())\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        -512
      ],
      "id": "51e26487-4019-48a7-ae21-5ac45f140d60",
      "name": "Sugerir Horarios Cercanos"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n    \"results\": [\n        {\n            \"toolCallId\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].id }}\",\n            \"result\": \"No esta disponible ese horario, intenta seleccionar otro día u hora.\"\n        }\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        224,
        -320
      ],
      "id": "09b29653-5d59-4cac-bdd7-707d1af2ddc7",
      "name": "No hay huecos libres"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n    \"results\": [\n        {\n            \"toolCallId\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].id }}\",\n            \"result\": \"{{ $('Sugerir Horarios Cercanos').item.json.message }}\"\n        }\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        448,
        -512
      ],
      "id": "31f6a5e1-672c-4101-92c8-3c1b51db8646",
      "name": "Huecos libres"
    },
    {
      "parameters": {
        "url": "https://api.cal.com/v2/slots",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "username",
              "value": "={{ $('Setear Variables').item.json.username }}"
            },
            {
              "name": "eventTypeSlug",
              "value": "={{ $('Setear Variables').item.json.eventTypeSlug }}"
            },
            {
              "name": "start",
              "value": "={{ $json.start }}"
            },
            {
              "name": "end",
              "value": "={{ $json.end }}"
            },
            {
              "name": "=timeZone",
              "value": "={{$('Webhook').item.json.body.message.toolCalls[0].function.arguments.zonaHoraria || 'Europe/Madrid'}}"
            },
            {
              "name": "duration",
              "value": "={{ $('Webhook').item.json.body.message.toolCalls[0].function.arguments.duracionMinutos }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "cal-api-version",
              "value": "2024-09-04"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -240,
        -416
      ],
      "id": "0147a010-14ea-4834-9e24-0aca1d2bb4fd",
      "name": "Mirar Disponibilidad",
      "credentials": {
        "httpHeaderAuth": {
          "id": "tmSbRYPaoOYHbWPX",
          "name": "Cal API Derma"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "22767100-ef1c-4356-aa4a-3b58d4f81075",
              "name": "start",
              "value": "={{ DateTime.fromISO($('Webhook').item.json.body.message.toolCalls[0].function.arguments.citaSolicitada).setZone($('Webhook').item.json.body.message.toolCalls[0].function.arguments.zonaHoraria).startOf('day').toISO() }}",
              "type": "string"
            },
            {
              "id": "0f4d3db6-9958-4cff-a310-3536c544e19d",
              "name": "end",
              "value": "={{ DateTime.fromISO($('Webhook').item.json.body.message.toolCalls[0].function.arguments.citaSolicitada).setZone($('Webhook').item.json.body.message.toolCalls[0].function.arguments.zonaHoraria).startOf('day').plus({ days: 1 }).toISO() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -464,
        -416
      ],
      "id": "431c6661-d3a6-494d-998f-04bcb5e19e4a",
      "name": "Comienzo y Final"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "46aadd77-eb8f-4351-8b88-26c7fcb82e03",
              "leftValue": "={{ $json.data }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -16,
        -416
      ],
      "id": "c0afe87c-9bb2-4dd1-878e-54e60e9d645f",
      "name": "Are Slots Available"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.message.toolCalls[0].function.name }}",
                    "rightValue": "mirar_disponibilidad",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5fa12cfb-483b-4fda-89b2-33908d2a727e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mirarDisponibilidad"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b2678560-ec05-4e9d-bb66-6944e049ff7f",
                    "leftValue": "={{ $('Webhook').item.json.body.message.toolCalls[0].function.name }}",
                    "rightValue": "agendar_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agendarCita"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -672,
        -224
      ],
      "id": "8231ad22-5b9f-4df6-8381-62beb419736d",
      "name": "Elegir Herramienta"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "545026d0-60db-4a72-860a-80bec6d1dd6d",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1136,
        -224
      ],
      "id": "100b6760-7f04-430d-a7ab-24201bc8e11e",
      "name": "Webhook",
      "webhookId": "ee663f68-fa21-45a1-ae83-2ba5ce950a65"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cal.com/v2/bookings",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "cal-api-version",
              "value": "2024-08-13"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"attendee\": {\n    \"language\": \"es\",\n    \"name\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].function.arguments.nombre }}\",\n    \"timeZone\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].function.arguments.zonaHoraria || 'Europe/Madrid' }}\",\n    \"email\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].function.arguments.correo }}\"\n  },\n  \"start\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].function.arguments.citaSolicitada.toDateTime().toUTC().toISO() }}\",\n  \"lengthInMinutes\": {{ +$('Webhook').item.json.body.message.toolCalls[0].function.arguments.duracionMinutos }},\n  \"eventTypeSlug\": \"{{ $('Setear Variables').item.json.eventTypeSlug }}\",\n  \"username\": \"{{ $('Setear Variables').item.json.username }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -464,
        -128
      ],
      "id": "eb1d5b07-355e-4bd2-82e4-196b8273a57a",
      "name": "Agendar Cita",
      "credentials": {
        "httpHeaderAuth": {
          "id": "tmSbRYPaoOYHbWPX",
          "name": "Cal API Derma"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n    \"results\": [\n        {\n            \"toolCallId\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].id }}\",\n            \"result\": \"La cita ha sido agendada con éxito.\"\n        }\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -240,
        -224
      ],
      "id": "47a7864b-0f0d-4691-8e24-f7cd7bee579d",
      "name": "Cita agendada con exito"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n    \"results\": [\n        {\n            \"toolCallId\": \"{{ $('Webhook').item.json.body.message.toolCalls[0].id }}\",\n            \"result\": \"La reserva no se ha realizado con éxito. Prueba con otro día u hora.\"\n        }\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -240,
        -32
      ],
      "id": "fb1be92d-3b4a-4e1e-8613-9c10c9c3b0cd",
      "name": "Cita no agendada"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "23cae85f-0868-4a99-9fd4-a8f379728d1b",
              "name": "username",
              "value": "empathoai",
              "type": "string"
            },
            {
              "id": "9d111618-82d3-4cbe-a2ea-07d87060b551",
              "name": "eventTypeSlug",
              "value": "deremam",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -912,
        -224
      ],
      "id": "99df447c-16d0-4c6c-aa54-2e035da57016",
      "name": "Setear Variables"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-11-05T21:08:32.321Z",
      "createdAt": "2025-11-05T21:08:32.321Z",
      "role": "workflow:owner",
      "workflowId": "KTdNVJBTrV4GXBkj",
      "projectId": "zIvgruNDMJwjqAqX"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "updatedAt": "2025-11-06T08:06:15.158Z",
      "createdAt": "2025-11-06T08:06:15.158Z",
      "id": "KRTaHczxl2RwluWo",
      "name": "AssistantDerma"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-11-06T10:54:45.000Z",
  "versionId": "1f33633e-45f2-4b78-b8c1-196070898a5e"
}